{"version":3,"sources":["js/CompileUtil.js","js/Compile.js","js/Observer.js","js/MVVM.js","js/index.js"],"names":["CompileUtil","getVal","vm","exp","split","reduce","prev","next","$data","setVal","newVal","currentIndex","length","getTextVal","replace","text","node","updateFn","updater","value","Watcher","newValue","model","addEventListener","e","target","textUpdater","textContent","modelUpdater","Compile","el","isElementNode","document","querySelector","fragment","nodeToFragment","compile","appendChild","nodeType","name","includes","createDocumentFragment","firstChild","childNodes","Array","from","forEach","compileElement","compileText","attrs","attributes","attr","attrName","isDirective","type","reg","test","Observer","data","observe","Object","keys","key","defineReactive","object","_this","dep","Dep","defineProperty","enumerable","configurable","get","addSub","set","notify","MVVM","options","$el","proxyData","message"],"mappings":"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","file":"js.00a46daa.map","sourceRoot":"..","sourcesContent":["var CompileUtil = {\n  getVal (vm, exp) { // 获取实例上对应的数据\n      exp = exp.split('.');\n      return exp.reduce((prev, next) => {\n          return prev[next];\n      }, vm.$data);\n  },\n  setVal (vm, exp, newVal) { // 设置实例上对应的数据\n      exp = exp.split('.');\n      return exp.reduce((prev, next, currentIndex) => {\n          if(currentIndex === exp.length - 1) {\n              return prev[next] = newVal;\n          }\n          return prev[next];\n      }, vm.$data);\n  },\n  getTextVal (vm, exp) { // 获取编译文本后的结果\n      return exp.replace(/\\{\\{([^}]+)\\}\\}/g, (...arg) => {\n          return this.getVal(vm, arg[1]);\n      });\n  },\n  text (node, vm, exp) { //文本处理\n      let updateFn = this.updater['textUpdater'];\n      let value = this.getTextVal(vm, exp);\n      exp.replace(/\\{\\{([^}]+)\\}\\}/g, (...arg) => {\n          new Watcher(vm, arg[1], newValue => {\n              // 如果数据变化了，文本节点应该重新获取依赖的数据更新文本中的内容\n              updateFn && updateFn(node, newValue);\n          });\n      });\n\n      updateFn && updateFn(node, value);\n  },\n  model (node, vm, exp) { // 输入框处理\n      let updateFn = this.updater['modelUpdater'];\n      let value = this.getVal(vm, exp);\n      // 这里应该加一个监控，数据变化了，应该调用 watch 的回调\n      new Watcher(vm, exp, newValue => {\n          updateFn && updateFn(node, newValue);\n      });\n      // 添加输入框事件实现双向绑定\n      node.addEventListener('input', e => {\n          let newValue = e.target.value;\n          this.setVal(vm, exp, newValue);\n      });\n      // 防止没有的指令解析时报错\n      updateFn && updateFn(node, value);\n  },\n  updater: {\n      // 文本更新\n      textUpdater (node, value) {\n          node.textContent = value;\n      },\n      // 输入框更新\n      modelUpdater (node, value) {\n          node.value = value;\n      }\n  }\n};\n\nexport default CompileUtil","import CompileUtil from './CompileUtil'\nexport default class Compile {\n  constructor (el, vm) {\n      this.el = this.isElementNode(el) ? el : document.querySelector(el);\n      this.vm = vm;\n      if(this.el) {\n          // 如果这个元素能获取到，我们才开始编译\n          // 1.先把这些真实的 DOM 移动到内存种 fragment\n          let fragment = this.nodeToFragment(this.el);\n          // 2.编译 => 提取想要的元素节点 v-model 和文本节点 {{message}}\n          this.compile(fragment);\n          // 把编译好的 fragment再塞回到页面中去\n          this.el.appendChild(fragment);\n      }\n  }\n\n  /* 专门写一些辅助方法 */\n  isElementNode (node) { // 是不是 dom 节点\n      return node.nodeType === 1;\n  }\n  isDirective (name) { // 是不是指令\n      return name.includes('v-');\n  }\n\n  /* 核心方法 */\n  nodeToFragment (el) { // 需要将 el 中的内容全部放到内存中\n      // 文档碎片 内存中的 dom 节点\n      let fragment = document.createDocumentFragment();\n      let firstChild;\n      while(firstChild = el.firstChild) {\n          fragment.appendChild(firstChild);\n      }\n      return fragment; // 内存中的节点\n  }\n  compile (fragment) { // 编译文档碎片方法\n      // 需要递归\n      let childNodes = fragment.childNodes;\n      Array.from(childNodes).forEach(node => {\n          if(this.isElementNode(node)) {\n              // 是元素节点，还需要继续深入的检查\n              // console.log('element', node);\n              this.compile(node);\n              // 这里需要编译元素\n              this.compileElement(node);\n          } else {\n              // 是文本节点\n              // console.log('text', node);\n              // 这里需要编译文本\n              this.compileText(node);\n          }\n      });\n  }\n  compileElement (node) { // 编译元素节点\n      // 带 v-model 的\n      let attrs = node.attributes; // 取出当前节点的属性\n      Array.from(attrs).forEach(attr => {\n          // 判断属性名字是不是包含 v-\n          let attrName = attr.name;\n          if(this.isDirective(attrName)) {\n              // 取到对应的值，放在节点中\n              let exp = attr.value;\n              let [, type] = attrName.split('-');\n              // node this.vm.$date exp\n              CompileUtil[type](node, this.vm, exp);\n          }\n      });\n  }\n  compileText (node) { // 编译文本节点\n      // 带 {{}} 的\n      let exp = node.textContent; // 获取文本中的内容\n      let reg = /\\{\\{([^}]+)\\}\\}/g; // {{a}} {{b}} {{c}}\n      if(reg.test(exp)) {\n          // node this.vm.$date exp\n          CompileUtil['text'](node, this.vm, exp);\n      }\n  }\n}\n\n","export default class Observer {\n  constructor (data) {\n      this.observe(data);\n  }\n  observe (data) {\n      // 验证 data\n      if(!data || typeof data !== 'object') {\n          return;\n      }\n\n      // 要对这个 data 数据将原有的属性改成 set 和 get 的形式\n      // 要将数据一一劫持，先获取到 data 的 key 和 value\n      Object.keys(data).forEach(key => {\n          // 劫持（实现数据响应式）\n          this.defineReactive(data, key, data[key]);\n          this.observe(data[key]); // 深度劫持\n      });\n  }\n  defineReactive (object, key, value) { // 响应式\n      let _this = this;\n      // 每个变化的数据都会对应一个数组，这个数组是存放所有更新的操作\n      let dep = new Dep();\n\n      // 获取某个值被监听到\n      Object.defineProperty(object, key, {\n          enumerable: true,\n          configurable: true,\n          get () { // 当取值时调用的方法\n              Dep.target && dep.addSub(Dep.target);\n              return value;\n          },\n          set (newValue) { // 当给 data 属性中设置的值适合，更改获取的属性的值\n              if(newValue !== value) {\n                  _this.observe(newValue); // 重新赋值如果是对象进行深度劫持\n                  value = newValue;\n                  dep.notify(); // 通知所有人数据更新了\n              }\n          }\n      });\n  }\n}\n\n","import Observer from './Compile'\nimport Compile from './Observer'\n\nexport default class MVVM {\n  constructor(options) {\n      // 先把 el 和 data 挂在 MVVM 实例上\n      this.$el = options.el;\n      this.$data = options.data;\n\n      // 如果有要编译的模板就开始编译\n      if (this.$el) {\n          // 数据劫持，就是把对象所有的属性添加 get 和 set\n          new Observer(this.$data);\n\n          // 将数据代理到实例上\n          this.proxyData(this.$data);\n\n          // 用数据和元素进行编译\n          new Compile(this.$el, this);\n      }\n  }\n  proxyData(data) { // 代理数据的方法\n      Object.keys(data).forEach(key => {\n          Object.defineProperty(this, key, {\n              get() {\n                  return data[key];\n              },\n              set(newVal) {\n                  data[key] = newVal;\n              }\n          });\n      });\n  }\n}","import MVVM from './MVVM'\nlet vm = new MVVM({\n  el: '#app',\n  data: {  \n      message: 'hello world!'\n  }\n});"]}